<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Microcredenciais Paraná</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- CSS -->
  <link rel="stylesheet" href="../css/encaminhamento.css">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- PDF-lib -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
</head>

<body>

<!-- NAV -->
<nav class="top-nav">
  <div class="nav-container" style="max-width: 1700px; width: 96%;">
    <div class="nav-logo">
      <img src="../imagem/logo_microcredenciais.png" height="80" alt="Microcredenciais Paraná">
    </div>
  </div>
</nav>

<!-- CONTEÚDO -->
<!-- <main class="container"> -->
    <main style="width: min(96vw, 1700px); margin: 32px auto 40px; padding: 24px 16px; flex: 1; background: transparent; box-shadow: none; border-radius: 0; box-sizing: border-box;">

  <!-- ================= encaminhamento ================= -->
  <section class="hero-content">
    <h1 class="title">
      Encaminhamento
      <span class="subtitle">Parabéns</span>
    </h1>
<br>
<!-- ÁUDIO EXPLICATIVO (INLINE, SEM MODAL) -->
<div class="mb-3">

  <!-- ÍCONE DE ÁUDIO -->
  <img
    src="../imagem/audio.png"
    alt="Ouvir orientações"
    title="Ouvir orientações"
    class="audio-icon-img"
    onclick="toggleAudioOrientacoes9()">

  <!-- PLAYER INLINE (OCULTO POR PADRÃO) -->
  <div id="audioInlineOrientacoes9"
       style="display:none; margin-top:8px; max-width:280px;">

    <iframe
      src="https://drive.google.com/file/d/1mkAEJS903Cx-2qUZ4LxWU94JJq503AsI/preview"
      width="100%"
      height="48"
      allow="autoplay"
      style="border:0; border-radius:6px;">
    </iframe>

  </div>

</div>

 <div class="message-box">
  <p>
    Você concluiu o desenvolvimento do seu curso! Faça uma conferência geral.
    Caso precise ajustar algo, retorne às etapas anteriores.
    Estando tudo correto, utilize as ações abaixo.
  </p>

  <!-- AÇÕES FINAIS -->
  <div style="
      display: flex;
      justify-content: center;
      gap: 40px;
      margin-top: 30px;
      flex-wrap: wrap;
  ">

    <!-- ===== PASSO 1 ===== -->
    <div style="text-align:center; max-width:260px;">
      <button id="btnFinalizarCurso" class="btn-moodle">
        Passo 1 · Gerar PDF Final
      </button>

      <small class="upload-hint" style="display:block; margin-top:8px;">
        PDF, imagens ou documentos • múltiplos arquivos
      </small>
    </div>

    <!-- ===== PASSO 2 ===== -->
    <div style="text-align:center; max-width:260px;">
      <button id="btnMoodle" class="btn-moodle">
        Passo 2 · Envio no Moodle
      </button>

      <p style="margin-top:8px; font-size:14px; color:#64748b;">
        O envio oficial deve ser realizado no AVA Moodle da UVPR.
      </p>
    </div>

  </div>
</div>

  
 <div class="menu-grid" style="display:flex; justify-content:center; gap:30px;">

  <!-- BOTÃO ANTERIOR -->
  <a href="./encaminhamento_1.html" class="menu-item blue">
    <div class="icon-container">
      <div class="icon-inner">
        <img src="../imagem/esquerda.png" alt="Anterior" style="width:50%;">
      </div>
    </div>
    <div class="label">Anterior</div>
  </a>

  <!-- BOTÃO HOME -->
  <a href="../index.html" class="menu-item blue">
    <div class="icon-container">
      <div class="icon-inner">
        <img src="../imagem/home.png" alt="Home" style="width:50%;">
      </div>
    </div>
    <div class="label">Home</div>
  </a>

</div>

</main>
    
 <footer class="bottom-nav">
  <div class="footer-container" style="max-width: 1700px; width: 96%; margin-top: 10px;">
    <p>&copy; 2026 UVPR - Universidade Virtual do Paraná</p>
  </div>
</footer>

<!-- ======================================================
     JAVASCRIPT — LEITURA DOS IDS + PDF + MOODLE
====================================================== -->
<script>
  /* ================= Áudio ================= */
  function toggleAudioOrientacoes9() {
  const audio = document.getElementById("audioInlineOrientacoes9");
  audio.style.display =
    audio.style.display === "none" ? "block" : "none";
}

/* ================= CONFIG ================= */
const DB_NAME = "microcredenciais_db";
const STORE_META = "meta";

/* ================= DB ================= */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

/* ================= META ================= */
async function getMeta(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const req = db.transaction(STORE_META)
      .objectStore(STORE_META)
      .get(key);
    req.onsuccess = () => resolve(req.result?.value || "");
  });
}

/* ================= PDF FINAL ================= */
async function gerarPdfFinal() {

  const pdf = await PDFLib.PDFDocument.create();
  const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);

  let page = pdf.addPage([595.28, 841.89]);
  let y = 800;

  /* ================= Função do Bloco para não cortar linha ================= */
  function bloco(titulo, conteudo) {

  const margemX = 50;
  const larguraMax = 495;
  const tamanhoTitulo = 14;
  const tamanhoTexto = 11;
  const alturaLinha = 16;

  // Nova página antes do título
  if (y < 120) {
    page = pdf.addPage([595.28, 841.89]);
    y = 800;
  }

  // Título
  page.drawText(titulo, { x: margemX, y, size: tamanhoTitulo, font });
  y -= 22;

  const texto = conteudo && String(conteudo).trim() !== "" ? conteudo : "—";

  let linha = "";

  for (let i = 0; i < texto.length; i++) {
    const char = texto[i];
    const testeLinha = linha + char;
    const largura = font.widthOfTextAtSize(testeLinha, tamanhoTexto);

    if (largura > larguraMax) {
      page.drawText(linha, { x: margemX, y, size: tamanhoTexto, font });
      linha = char;
      y -= alturaLinha;

      if (y < 120) {
        page = pdf.addPage([595.28, 841.89]);
        y = 800;
      }
    } else {
      linha = testeLinha;
    }

    // Quebra manual por ENTER
    if (char === "\n") {
      page.drawText(linha.replace("\n", ""), {
        x: margemX,
        y,
        size: tamanhoTexto,
        font
      });
      linha = "";
      y -= alturaLinha;

      if (y < 120) {
        page = pdf.addPage([595.28, 841.89]);
        y = 800;
      }
    }
  }

  // Última linha
  if (linha.trim() !== "") {
    page.drawText(linha, { x: margemX, y, size: tamanhoTexto, font });
    y -= alturaLinha;
  }

  y -= 18;
}


  /* ===== Apresentação - ETAPA 1 - IDS OBRIGATÓRIOS ===== */
  const courseName = await getMeta("courseName");
  const synopsis = await getMeta("synopsis");
  
    /* ===== Apresentação - ETAPA 2 ===== */
  const nivel = await getMeta("nivel");
  const carga = await getMeta("carga");
  const competencia = await getMeta("competencia");

  /* ===== IDS TÓPICOS (apresentacao_1.html) =====
     Regras por carga horária:
     20h -> 2 tópicos | 30h -> 3 | 40h -> 4 | 50h -> 5 | 60h -> 6
  ============================================ */
  const topicos = [];
  for (let i = 1; i <= 6; i++) {
    topicos.push(await getMeta(`topico${i}`));
  }

  const cargaNum = parseInt((String(carga).match(/\d+/) || [""])[0], 10);
  const qtdTopicosPorCarga = { 20: 2, 30: 3, 40: 4, 50: 5, 60: 6 };
  const qtdTopicos = qtdTopicosPorCarga[cargaNum] || 2;

  /* ===== Apresentação Etapa 03 ===== */
  const apnprofessor = await getMeta("apnprofessor");
  const youtubeProfessor = await getMeta("youtubeProfessor");
  const lattesUrl = await getMeta("lattesUrl");

    
  /* ===== Apresentação do curso com parágrafo Etapa 3 ===== */
  const textoCurso = await getMeta("textoCurso");


  /* ===== Definição do Desafio ===== */
  const textodesafio = await getMeta("textodesafio");
  const videodesafio = await getMeta("videodesafio");

  /* ===== Teorias e Conceitos ===== */
  const textounidade1 = await getMeta("textounidade1");
  const youtubedaunidade = await getMeta("youtubedaunidade");
  

  const textounidade2 = await getMeta("textounidade2");
  const youtubedaunidade2 = await getMeta("youtubedaunidade2");

  const textounidade3 = await getMeta("textounidade3");
  const youtubedaunidade3 = await getMeta("youtubedaunidade3");

  const textounidade4 = await getMeta("textounidade4");
  const youtubedaunidade4 = await getMeta("youtubedaunidade4");

    /* ===== Teorias e Conceitos 5 ===== */
  const textounidade5 = await getMeta("textounidade5");
  const youtubedaunidade5 = await getMeta("youtubedaunidade5");
  
  const textounidade6 = await getMeta("textounidade6");
  const youtubedaunidade6 = await getMeta("youtubedaunidade6");

  /* ===== Exemplos de Cases 02 ===== */
  const estudoCaso2 = await getMeta("estudoCaso2");
  const youtubeAula2 = await getMeta("youtubeAula2");

 /* ===== Exemplos de Cases 03 ===== */
  const estudoCaso3 = await getMeta("estudoCaso3");
  const youtubeAula3 = await getMeta("youtubeAula3");

   /* ===== Plano de Ação Página única ===== */
  const planoAcaoTexto = await getMeta("planoAcaoTexto");
  const youtubePlanoAcao = await getMeta("youtubePlanoAcao");
  const linkPlanoAcao = await getMeta("linkPlanoAcao");

  /* ===== Plano de Ação Final ===== */
  const planoAcaoTexto2 = await getMeta("planoAcaoTexto2");
  const videoPlanoAcao2 = await getMeta("videoPlanoAcao2");


  /* ===== Revisão e Fechamento ===== */
const revisaoConteudos = await getMeta("revisaoConteudos");
const youtubeRevisao = await getMeta("youtubeRevisao");

  /* ===== Avaliação ===== */
const textoAvaliacao = await getMeta("textoAvaliacao");

  /* ===== encaminhamento / Transformação ===== */
const textoencaminhamento = await getMeta("textoencaminhamento");


  /* ===== PDF ===== */
  page.drawText("CURSO – MICROCREDENCIAIS PARANÁ", {
    x: 50, y, size: 18, font
  });
  y -= 40;

 /* ===== IDS OBRIGATÓRIOS ===== */
  bloco("Curso", courseName);
  bloco("Sinopse", synopsis);

  /* ===== TÓPICOS (dinâmico conforme a carga horária) ===== */
  for (let i = 1; i <= qtdTopicos; i++) {
    bloco(`Conteúdo ${String(i).padStart(2, "0")}`, topicos[i - 1]);
  }
  bloco("Nível", nivel);
  bloco("Carga Horária", carga ? `${cargaNum || carga}h` : "");
  bloco("Competência", competencia);
   
  /* ===== Apresentação 4  ===== */
  bloco("Apresentação do Professor", apnprofessor);
  bloco("Vídeo do Professor", youtubeProfessor);
  bloco("Currículo Lattes", lattesUrl);

  /* ===== Apresentação 3  ===== */
  bloco("Apresentação do Curso", textoCurso);


  /* ===== Definição do Desafio 2  ===== */
  bloco("Texto da Definição do Desafio", textodesafio);
  bloco("Vídeo Definição do Desafio", videodesafio);


  /* ===== ESTUDOS DE CASO ===== */
bloco("Estudo de Caso 02", estudoCaso2);
bloco("Vídeo Aula – Estudo de Caso 02", youtubeAula2);

bloco("Estudo de Caso 03", estudoCaso3);
bloco("Vídeo Aula – Estudo de Caso 03", youtubeAula3);



/* ===== PLANO DE AÇÃO 01 ===== */
bloco(
  "Plano de Ação – Desenvolvimento, Aplicação e Avaliação",
  planoAcaoTexto
);

bloco(
  "Vídeo do Plano de Ação",
  youtubePlanoAcao
);

bloco(
  "Link de Acesso ao Plano de Ação",
  linkPlanoAcao
);

/* ===== PLANO DE AÇÃO 02 ===== */
bloco(
  "Plano de Ação – Desenvolvimento, Aplicação e Avaliação",
  planoAcaoTexto2
);
bloco(
  "Link do Vídeo de Acesso ao Plano de Ação",
  videoPlanoAcao2
);


 /* ===== Avaliação ===== */
bloco("Avaliação – Questões Avaliativas",textoAvaliacao
);

 /* ===== encaminhamento / Transformação ===== */
bloco("encaminhamento", textoencaminhamento);

  /* ===== Revisão dos Conteúdos ===== */
bloco("Revisão dos Conteúdos", revisaoConteudos);
bloco("Vídeo – Revisão e Fechamento", youtubeRevisao);

    /* ===== Teorias e Conceitos 4  ===== */
  bloco("Unidade 01", textounidade1);
  bloco("Vídeo Unidade 01", youtubedaunidade);
  
  /* ===== Teorias e Conceitos 5  ===== */
  bloco("Unidade 02", textounidade2);
  bloco("Vídeo Unidade 02", youtubedaunidade2);

  /* ===== Teorias e Conceitos Unidade 3  ===== */
  bloco("Unidade 03", textounidade3);
  bloco("Vídeo Unidade 03", youtubedaunidade3);

   /* ===== Teorias e Conceitos 7  ===== */
  bloco("Unidade 04", textounidade4);
  bloco("Vídeo Unidade 04", youtubedaunidade4);

    /* ===== Teorias e Conceitos 8  ===== */
  bloco("Unidade 05", textounidade5);
  bloco("Vídeo Unidade 05", youtubedaunidade5);


    /* ===== Teorias e Conceitos 9  ===== */
  bloco("Unidade 06", textounidade6);
  bloco("Vídeo Unidade 06", youtubedaunidade6);

  return await pdf.save();
}

/* ================= EVENTOS ================= */

// GERAR PDF
document.getElementById("btnFinalizarCurso")
  .addEventListener("click", async () => {

    Swal.fire({
      title: "Gerando PDF final…",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const pdfBytes = await gerarPdfFinal();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      window.open(url, "_blank");

      Swal.fire(
        "Concluído!",
        "PDF final gerado com sucesso. Faça a conferência.",
        "success"
      );

    } catch (err) {
      console.error(err);
      Swal.fire("Erro", err.message, "error");
    }
  });

// REDIRECIONAR PARA MOODLE
document.getElementById("btnMoodle")
  .addEventListener("click", () => {
    window.open(
      "https://ava2.uvpr.pr.gov.br/mod/assign/view.php?id=2092",
      "_blank"
    );
  });
</script>

</body>
</html>
