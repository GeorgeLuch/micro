<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <title>Microcredenciais Paran√°</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootswatch -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/litera/bootstrap.min.css">

  <!-- SweetAlert -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- PDF-lib (SEM defer) -->
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <link rel="stylesheet" href="../css/apresentacao.css">
</head>

<body>

<!-- NAV -->
<nav class="top-nav">
  <div class="nav-container">
    <div class="nav-logo">
      <img src="../imagem/logo_microcredenciais.png" height="80">
    </div>
  </div>
</nav>

<!-- CONTE√öDO -->
<main class="container">

  <section class="hero-content">
    <h1 class="title">
      Apresenta√ß√£o do(a) Professor(a)z
      <span class="subtitle">Finaliza√ß√£o</span>
    </h1>

    <div class="message-box">
      <p>
        Ao clicar em <b>Pr√≥ximo</b>, todo o conte√∫do das etapas
        ser√° reunido em <b>um √∫nico PDF</b>.
      </p>
    </div>
  </section>

  <!-- TEXTO -->
  <label class="form-label fw-semibold">
    Apresenta√ß√£o do(a) professor(a)
  </label>

  <textarea
    class="texto form-control form-control-lg mb-4"
    data-field="6"
    rows="5"
    placeholder="Escreva aqui sua apresenta√ß√£o"></textarea>

  <!-- YOUTUBE -->
  <label class="form-label fw-semibold">
    Link do v√≠deo do professor
  </label>

  <input
    type="url"
    class="form-control mb-4"
    id="youtubeProfessor"
    placeholder="https://www.youtube.com/watch?v=..."
  />

  <!-- LATTES -->
  <label class="form-label fw-semibold">
    Curr√≠culo Lattes
  </label>

  <input
    type="url"
    class="form-control mb-4"
    id="lattesUrl"
    placeholder="https://lattes.cnpq.br/"
  />

  <!-- MENU -->
  <div class="menu-grid">

     <a href="./apresentacao_3.html" class="menu-item blue">
      <div class="icon-container">
        <div class="icon-inner">
          <img src="../imagem/esquerda.png" alt="Avalia√ß√£o" style="width: 50%; height: auto;">
            </div>
            </div>
        <div class="label">Anterior</div>
  </a>
    

    <a href="../index.html" class="menu-item blue">
  <div class="icon-container">
    <div class="icon-inner">
      <img src="../imagem/home.png" alt="Home" style="width: 50%; height: auto;">
    </div>
  </div>
  <div class="label">Home</div>
</a>


    <a href="#" id="btnFinalizarApresentacao" class="menu-item blue">
  <div class="icon-container">
    <div class="icon-inner">
      <img src="../imagem/direita.png" alt="Pr√≥ximo" style="width: 50%; height: auto;">
    </div>
  </div>
  <div class="label">Pr√≥ximo</div>
</a>


  </div>

    <!-- LEMBRETE -->
    <div class="message-box">
      <p>
        <b>
          LEMBRETE:
        </b>
        Chegamos no final de sua jornada!
        Agora √© o momento de baixar o PDF para fazer uma √∫ltima revis√£o antes do envio.
        üìÑ Fa√ßa o download do arquivo em PDF para o seu computador.
      </p>
    </div>
</main>

<footer class="bottom-nav">
  <div class="footer-container">
    <p>&copy; 2026 UVPR - Universidade Virtual do Paran√°</p>
  </div>
</footer>

<!-- ======================================================
     JAVASCRIPT FINAL ‚Äî 100% LOCAL (SEM FETCH)
====================================================== -->
<script>
/* ================= CONFIG ================= */
const DB_NAME = "microcredenciais_db";
const STORE_META = "meta";
const STORE_TEXTS = "texts";

/* ================= DB ================= */
function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_META))
        db.createObjectStore(STORE_META, { keyPath: "key" });
      if (!db.objectStoreNames.contains(STORE_TEXTS))
        db.createObjectStore(STORE_TEXTS, { keyPath: "field" });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

/* ================= META ================= */
async function putMeta(key, value) {
  const db = await openDB();
  db.transaction(STORE_META, "readwrite")
    .objectStore(STORE_META)
    .put({ key, value: value ?? "" });
}

async function getMeta(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const req = db.transaction(STORE_META)
      .objectStore(STORE_META)
      .get(key);
    req.onsuccess = () => resolve(req.result?.value || "");
  });
}

/* ================= TEXTOS ================= */
async function putText(field, value) {
  const db = await openDB();
  db.transaction(STORE_TEXTS, "readwrite")
    .objectStore(STORE_TEXTS)
    .put({ field: Number(field), value: value || "" });
}

async function getAllTexts() {
  const db = await openDB();
  return new Promise(resolve => {
    const req = db.transaction(STORE_TEXTS)
      .objectStore(STORE_TEXTS)
      .getAll();
    req.onsuccess = () => resolve(req.result || []);
  });
}

/* ================= AUTOSAVE + RESTORE ================= */
document.addEventListener("DOMContentLoaded", async () => {

  const fields = document.querySelectorAll("input, textarea, select");

  /* ===== RESTAURA ===== */
  const texts = await getAllTexts();
  const map = {};
  texts.forEach(t => map[t.field] = t.value);

  for (const el of fields) {
    if (el.dataset.field) {
      el.value = map[el.dataset.field] || "";
    } else if (el.id) {
      el.value = await getMeta(el.id);
    }
  }

  /* ===== SALVA AUTOMATICAMENTE ===== */
  fields.forEach(el => {
    const save = () => {
      if (el.dataset.field) {
        putText(el.dataset.field, el.value);
      } else if (el.id) {
        putMeta(el.id, el.value);
      }
    };
    el.addEventListener("input", save);
    el.addEventListener("change", save);
  });
});

/* ================= PDF FINAL ================= */
async function gerarPdfFinal() {

  if (typeof PDFLib === "undefined") {
    throw new Error("PDFLib n√£o carregou");
  }

  const courseName = await getMeta("courseName");
  const synopsis = await getMeta("synopsis");
  const nivel = await getMeta("nivel");
  const carga = await getMeta("carga");
  const textoCurso = await getMeta("textoEtapa");
  const youtubeCurso = await getMeta("youtubeUrl");
  const youtubeProfessor = await getMeta("youtubeProfessor");
  const lattesUrl = await getMeta("lattesUrl");
  

  const textos = await getAllTexts();
  const topicos = textos
    .filter(t => t.field >= 1 && t.field <= 6)
    .sort((a, b) => a.field - b.field);

  const pdf = await PDFLib.PDFDocument.create();
  const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);

  let page = pdf.addPage([595.28, 841.89]);
  let y = 800;

  function bloco(titulo, conteudo) {
    if (y < 100) {
      page = pdf.addPage([595.28, 841.89]);
      y = 800;
    }
    page.drawText(titulo, { x: 50, y, size: 14, font });
    y -= 18;

    (conteudo || "‚Äî").split("\n").forEach(l => {
      page.drawText(l, { x: 50, y, size: 11, font });
      y -= 14;
    });
    y -= 16;
  }

  page.drawText("APRESENTA√á√ÉO COMPLETA ‚Äì MICROCREDENCIAIS", {
    x: 50, y, size: 18, font
  });
  y -= 40;

 // ===== DADOS DO CURSO =====
// ===== CURSO =====
bloco("Curso", courseName);
bloco("Sinopse", synopsis);

// ===== T√ìPICOS 01 A 04 =====
topicos
  .filter(t => t.field >= 1 && t.field <= 4)
  .sort((a, b) => a.field - b.field)
  .forEach(t => {
    bloco(`T√≥pico ${String(t.field).padStart(2, "0")}`, t.value);
  });

// ===== N√çVEL E CARGA =====
bloco("N√≠vel", nivel);
bloco("Carga Hor√°ria", carga);

// ===== APRESENTA√á√ÉO DO CURSO =====
bloco("Apresenta√ß√£o do Curso", textoCurso);

// ===== LINKS =====
bloco("Link do v√≠deo no YouTube (do curso)", youtubeCurso);
bloco("Link do v√≠deo da apresenta√ß√£o do professor", youtubeProfessor);
bloco("Curr√≠culo Lattes", lattesUrl);



  return await pdf.save();
}

/* ================= CLIQUE FINAL ================= */
document.getElementById("btnFinalizarApresentacao")
  .addEventListener("click", async e => {
    e.preventDefault();

    Swal.fire({
      title: "Gerando PDF √∫nico‚Ä¶",
      allowOutsideClick: false,
      didOpen: () => Swal.showLoading()
    });

    try {
      const pdfBytes = await gerarPdfFinal();
      const blob = new Blob([pdfBytes], { type: "application/pdf" });
      const url = URL.createObjectURL(blob);

      window.open(url, "_blank");

      Swal.fire("Conclu√≠do!", "PDF atualizado gerado com sucesso.", "success")
        .then(() => {
          window.location.href = "../desafio/desafio_0.html";
        });

    } catch (err) {
      console.error(err);
      Swal.fire("Erro", err.message, "error");
    }
  });
</script>


</body>
</html>
