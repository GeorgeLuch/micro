<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microcredenciais Paraná</title>

  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/litera/bootstrap.min.css">

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>
  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

  <link rel="stylesheet" href="../css/teoria_conceito.css">
</head>

<body>

<nav class="top-nav">
  <div class="nav-container" style="max-width: 1700px; width: 96%;">
    <div class="nav-logo">
      <img src="../imagem/logo_microcredenciais.png" height="80">
    </div>
  </div>
</nav>

<!-- <main class="container"> -->
    <main style="width: min(96vw, 1700px); margin: 32px auto 40px; padding: 24px 16px; flex: 1; background: transparent; box-shadow: none; border-radius: 0; box-sizing: border-box;">

  <section class="hero-content">
    <p><strong>Somente para disciplinas de 40 horas.</strong></p>
    <h1 class="title">Teorias e Conceitos <span class="subtitle">Unidade 04</span></h1>
    <div class="message-box">
      <p>Utilize os campos a seguir para enviar o conteúdo da Unidade.</p>
    </div>
  </section>

       <!-- TEXTO UNIDADE 4 -->
<textarea
  id="textounidade4"
  class="texto form-control form-control-lg mb-4"
  rows="5"
  placeholder="Insira aqui o texto referente à UNIDADE 04.">
</textarea>

<!-- YOUTUBE UNIDADE 4 -->
<label class="form-label fw-semibold" for="youtubedaunidade4">
  Insira aqui o link para o vídeo principal da unidade 4
</label>

<input
  type="url"
  class="form-control mb-3"
  id="youtubedaunidade4"
  placeholder="https://www.youtube.com/watch?v=..."
  autocomplete="off">


  <!-- MENU -->
  <div class="menu-grid">

    <a href="../teoria_conceito/teoria_conceito_06.html" class="menu-item blue">
      <div class="icon-container">
        <div class="icon-inner">
          <img src="../imagem/esquerda.png" style="width:50%">
        </div>
      </div>
      <div class="label">Anterior</div>
    </a>

    <a href="../teoria_conceito/teoria_conceito_0.html" class="menu-item blue">
      <div class="icon-container">
        <div class="icon-inner">
          <img src="../imagem/home.png" style="width:50%">
        </div>
      </div>
      <div class="label">Home</div>
    </a>

     <a href="../exemplo_case/exemplo_case_0.html" class="menu-item blue">
      <div class="icon-container">
        <div class="icon-inner">
          <img src="../imagem/direita.png" style="width:50%">
        </div>
      </div>
      <div class="label">Próximo</div>
    </a>

  </div>

</main>
    <!-- </main> -->

<footer class="bottom-nav">
  <div class="footer-container" style="max-width: 1700px; width: 96%;">
    <p>&copy; 2026 UVPR - Universidade Virtual do Paraná</p>
  </div>
</footer>

<!-- ======================================================
     JAVASCRIPT
====================================================== -->
<script>
/* ===== INDEXED DB ===== */
const DB_NAME = "microcredenciais_db";
const STORE_META = "meta";
const STORE_TEXTS = "texts";

function openDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = () => {
      const db = req.result;
      if (!db.objectStoreNames.contains(STORE_META))
        db.createObjectStore(STORE_META, { keyPath: "key" });
      if (!db.objectStoreNames.contains(STORE_TEXTS))
        db.createObjectStore(STORE_TEXTS, { keyPath: "field" });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
}

async function putMeta(key, value) {
  const db = await openDB();
  db.transaction(STORE_META, "readwrite")
    .objectStore(STORE_META)
    .put({ key, value });
}

async function getMeta(key) {
  const db = await openDB();
  return new Promise(resolve => {
    const req = db.transaction(STORE_META).objectStore(STORE_META).get(key);
    req.onsuccess = () => resolve(req.result?.value || "");
  });
}

async function putText(field, value) {
  const db = await openDB();
  db.transaction(STORE_TEXTS, "readwrite")
    .objectStore(STORE_TEXTS)
    .put({ field, value });
}

async function getAllTexts() {
  const db = await openDB();
  return new Promise(resolve => {
    const req = db.transaction(STORE_TEXTS).objectStore(STORE_TEXTS).getAll();
    req.onsuccess = () => resolve(req.result || []);
  });
}

/* ===== AUTOSAVE ===== */
document.addEventListener("DOMContentLoaded", async () => {

  const fields = document.querySelectorAll("textarea, input[type=url]");

  const texts = await getAllTexts();
  texts.forEach(t => {
    const el = document.querySelector(`[data-field="${t.field}"]`);
    if (el) el.value = t.value;
  });

  for (const el of fields) {
    if (el.id) el.value = await getMeta(el.id);

    el.addEventListener("input", () => {
      if (el.dataset.field) putText(Number(el.dataset.field), el.value);
      if (el.id) putMeta(el.id, el.value);
    });
  }

  /* ===== ANEXOS ===== */
  const input = document.getElementById("anexosUnidade04");
  const lista = document.getElementById("listaAnexos04");

  const salvos = JSON.parse(await getMeta("anexosUnidade04") || "[]");
  salvos.forEach(a => addAnexo(a.name, a.url));

  input.addEventListener("change", async () => {
    lista.innerHTML = "";
    const arquivos = Array.from(input.files).map(f => ({
      name: f.name,
      url: URL.createObjectURL(f)
    }));
    arquivos.forEach(a => addAnexo(a.name, a.url));
    await putMeta("anexosUnidade04", JSON.stringify(arquivos));
  });

  function addAnexo(nome, url) {
    const li = document.createElement("li");
    li.className = "list-group-item";
    li.innerHTML = `<a href="${url}" target="_blank">${nome}</a>`;
    lista.appendChild(li);
  }
});

/* ===== PDF ===== */
async function gerarPdf() {

  const texto = (await getAllTexts()).find(t => t.field === 704)?.value || "";
  const video = await getMeta("videoUnidade04");
  const anexos = JSON.parse(await getMeta("anexosUnidade04") || "[]");

  const pdf = await PDFLib.PDFDocument.create();
  const font = await pdf.embedFont(PDFLib.StandardFonts.Helvetica);
  let page = pdf.addPage([595, 842]);
  let y = 800;

  function write(title, content) {
    page.drawText(title, { x: 50, y, size: 14, font }); y -= 18;
    content.split("\n").forEach(l => {
      page.drawText(l, { x: 50, y, size: 11, font });
      y -= 14;
    });
    y -= 20;
  }

  write("Conteúdo da Unidade", texto);
  write("Vídeo da Unidade", video || "—");

  if (anexos.length) {
    write(
      "Arquivos Anexados",
      anexos.map(a => `${a.name} — ${a.url}`).join("\n")
    );
  }

  return pdf.save();
}

document.getElementById("btnFinalizarTeoria")
  .addEventListener("click", async e => {
    e.preventDefault();
    Swal.fire({ title: "Gerando PDF…", didOpen: () => Swal.showLoading() });
    const bytes = await gerarPdf();
    const url = URL.createObjectURL(new Blob([bytes], { type: "application/pdf" }));
    window.open(url, "_blank");
    Swal.close();
    location.href = "../exemplo_case/exemplo_case_0.html";
  });
</script>

</body>
</html>
